---
# vim:set sw=2 ts=8 et fileencoding=utf8:
# SPDX-License-Identifier: BSD-2-Clause
# SPDX-FileCopyrightText: 2025 Сергей Леонтьев (leo@sai.msu.ru)
#
# This starter workflow is for a CMake project running on multiple platforms.
# There is a different starter workflow if you just want a single platform.
# See:
# https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml

name: CMake on multiple platforms

on:  # yamllint disable-line rule:truthy
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  lcc_version: 1.27.23.e2k-v5.5.10
  lcc_dirname: lcc-$lcc_version
  lcc_tarname: cross-sp-rel-${{ env.lcc_version }}_64.tgz
  lcc_link: https://dev.mcst.ru/downloads/2025-05-12/${{ env.lcc_tarname }}

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      # Set fail-fast to false to ensure that feedback is delivered for all
      # matrix combinations. Consider changing this to true when your workflow
      # is stable.

      fail-fast: false

      # Set up a matrix to run the following 4 configurations:
      #
      # 1. <Latest MSVC compiler toolchain on the default runner image,
      # Windows, Release, default generator>
      #
      # 2. <Latest GCC compiler toolchain on the default runner image, Linux,
      # Release, default generator>
      #
      # 3. <Latest Clang compiler toolchain on the default runner image, Linux,
      # Release, default generator>
      #
      # 4. <oneAPI 2025.1, Linux, Release, default generator>
      #
      # 5. <LCC MCST Elbrus e2k, Linux, Release, default generator>
      #
      # To add more build types (Release, Debug, RelWithDebInfo, etc.)
      # customize the build_type list.

      matrix:
        c_compiler: [gcc, clang, cl, icx, lcc]
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]
        include:
          - c_compiler: cl
            cpp_compiler: cl
            os: windows-latest
            platform: "win32"
          - c_compiler: gcc
            cpp_compiler: g++
            os: ubuntu-latest
            platform: "linux"
          - c_compiler: clang
            cpp_compiler: clang++
            os: ubuntu-latest
            platform: "linux"
          - c_compiler: icx
            cpp_compiler: icpx
            oneapi: 2025.1
            os: ubuntu-latest
            platform: "linux"
          - c_compiler: lcc
            cpp_compiler: l++
            lcc: ${{ env.lcc }}
            dirname: ${{ env.dirname }}
            tarname: ${{ env.tarname }}
            link: ${{ env.link }}
            platform: "e2k"
        exclude:
          - os: windows-latest
            c_compiler: gcc
          - os: windows-latest
            c_compiler: clang
          - os: windows-latest
            c_compiler: icx
          - os: windows-latest
            c_compiler: lcc
          - os: ubuntu-latest
            c_compiler: cl

    steps:
      - uses: actions/checkout@v4

      - name: Cache install oneAPI
        if: ${{ matrix.c_compiler == 'icx' }}
        id: cache-icx
        uses: actions/cache@v4
        with:
          path: |
            /opt/intel/oneapi
          key: oneapi-${{ matrix.oneapi }}-apt

      - name: Non-cache install oneAPI
        if: ${{ matrix.c_compiler == 'icx' &&
                steps.cache-icx.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p /opt/intel/oneapi/dir
          touch /opt/intel/oneapi/dir/file
          echo "TENV=true; export TENV" > /opt/intel/oneapi/setvars.sh

      - name: Setup Intel oneAPI environment
        if: ${{ matrix.c_compiler == 'icx' }}
        run: |
          source /opt/intel/oneapi/setvars.sh
          printenv >> $GITHUB_ENV

      - name: Cache install LCC MCST Elbrus e2k
        if: ${{ matrix.c_compiler == 'lcc' }}
        id: cache-lcc
        uses: actions/cache@v4
        with:
          path: |
            /opt/mcst
            /usr/local/bin/e2k
            /usr/local/bin/qemu-e2k
            /usr/local/bin/lcc
            /usr/local/bin/l++
          key: cache-${{ matrix.lcc }}-mrognor

      - name: Non-cache install LCC MCST Elbrus e2k
        if: ${{ matrix.c_compiler == 'lcc' &&
                steps.cache-lcc.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p /opt/mcst/bin
          touch /opt/mcst/bin/lcc
          touch /opt/mcst/bin/l++
          ln -sf /opt/mcst/bin/lcc /opt/mcst/bin/l++ /usr/local/bin/.
          touch /usr/local/bin/e2k
          touch /usr/local/bin/qemu-e2k

      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install python module
        run: |
          python -c "import sys; print(sys.version); print(sys.executable)"
          python -m pip install --upgrade pip
          python -m pip install junitparser yamllint

      - name: Lint
        run: |
          python -m yamllint --list-file .
          python -m yamllint .

      - name: Linux short_example
        if: ${{ matrix.platform == 'linux' }}
        run: |
          if [ ${{ matrix.c_compiler }} == "icx" ] ; then
            wc /opt/intel/oneapi/dir/file && "$TENV"
          else
            true
          fi

      - name: E2k short_example
        if: ${{ matrix.platform == 'e2k' }}
        run: |
          echo "lcc=${{ matrix.lcc }}"
          echo "dirname=${{ matrix.dirname }}"
          echo "tarname=${{ matrix.tarname }}"
          echo "link=${{ matrix.link }}"
          wc /usr/local/bin/e2k /usr/local/bin/qemu-e2k /usr/local/bin/lcc \
             /usr/local/bin/l++

      - name: Windows short_example
        if: ${{ matrix.platform == 'win32' }}
        shell: cmd
        run: |
          exit 0 /b
